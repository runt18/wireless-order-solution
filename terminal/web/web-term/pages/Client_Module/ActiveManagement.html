<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="../../css/stepCss/main.css">
<link rel="stylesheet" href="../../css/stepCss/jquery.steps.css">
<style type="text/css">
.x-window-mc{
	font : 1.03em tahoma,arial,helvetica,sans-serif;
}
.active_mould{
	float: left;margin-left: 15px;margin-top: 10px;
}

.active_mould_default{
	border:3px solid #EEEEEE;
}

.active_mould_click{
	border:3px solid red;
}
</style>
<script type="text/javascript"
	src="../../js/Client/activeMgr/activeMgrMain.js"></script>
<script>
var active_memberList = '', couponTypeId = 0, promotionType = 4;
var promotionTree;
function buildPreviewHead(){
	var head = '';
	if(Ext.getCmp('active_title').getValue()){
		head +=  '<div style="text-align:center; font-size: 30px; font-weight: bold; word-wrap:break-word; color: #D2691E;">' + Ext.getCmp('active_title').getValue() + '</div>';
	}else{
		head +=  '<div style="text-align:center; font-size: 30px; font-weight: bold; word-wrap:break-word; color: #D2691E;">活动标题</div>';
	}
	
	if(Ext.getCmp('active_beginDate').getValue() && Ext.getCmp('active_endDate').getValue()){
		head += '<div style="margin: 10px 10px 10px 10px; color:#aaa; font-szie:12px;">活动日期 : ' + Ext.getCmp('active_beginDate').getValue().format('Y-m-d') + '&nbsp;至&nbsp;' + Ext.getCmp('active_endDate').getValue().format('Y-m-d') + '</div>';
	}
	
//	if(Ext.getCmp('active_point').isValid()){
		head += promotionRule(promotionType, Ext.getCmp('active_point').getValue());
//	}
	
	return head;
}	
var operatePromotion = function(){
	
	if(active_memberList == ''){
		Ext.example.msg('提示', '请选择参与活动的会员');
		return false;
	}
	
	var title = Ext.getCmp('active_title');
	var beginDate = Ext.getCmp('active_beginDate');
	var endDate = Ext.getCmp('active_endDate');
	var point = Ext.getCmp('active_point');
	var couponName = Ext.getCmp('active_couponName');
	var price = Ext.getCmp('active_price');
	var expiredDate= Ext.getCmp('active_couponExpiredDate');
	var editBody = Ext.getCmp('secondStep_edit');
	
	Ext.Ajax.request({
		url : '../../OperatePromotion.do',
		params : {
			dataSource : 'insert',
			couponTypeId : couponTypeId,
			pType : promotionType,
			couponName : couponName.getValue(),
			price : price.getValue(),
			expiredDate : expiredDate.getValue().format('Y-m-d'),
			image : operatePromotTypeWin.image ,
			title : title.getValue(),
			beginDate : beginDate.getValue().format('Y-m-d'),
			endDate : endDate.getValue().format('Y-m-d'),
			point : point.getValue(),
			members : active_memberList,
			body : editBody.getValue()
		},
		success : function(res, opt){
			var jr = Ext.decode(res.responseText);
			if(jr.success){
				promotionTree.getRootNode().reload();
				operatePromotTypeWin.hide();
				Ext.example.msg(jr.title, jr.msg);
			}
		},
		fialure : function(res, opt){
			wx.lm.hide();
			Ext.ux.showMsg(res.responseText);
		}
	});	
	
}

function fnValidSecondSteps(){
	var title = '提示';
	if(!Ext.getCmp('active_title').isValid()){
		Ext.example.msg(title, '请填写活动标题');
		return false;
	}
	
	if(!Ext.getCmp('active_endDate').isValid()){
		Ext.example.msg(title, '请填写活动时间');
		return false;
	}	
	
	if((promotionType == 3 || promotionType == 4) && !Ext.getCmp('active_point').isValid()){
		Ext.example.msg(title, '请填写积分条件');
		return false;
	}
	
	if(promotionType != 1 && !Ext.getCmp('active_couponExpiredDate').isValid()){
		Ext.example.msg(title, '请填写优惠劵到期时间');
		return false;
	}
	
	return true;
	
}

$(function (){
    $("#wizard").steps({
        headerTag: "span",
        bodyTag: "div",
        transitionEffect: "slideLeft",
        labels: {
            current: "current step:",
            pagination: "Pagination",
            finish: "完成",
            next: "下一步",
            previous: "上一步",
            loading: "加载中 ..."
        },
        onStepChanged: function (event, currentIndex, priorIndex) { 
        	if(currentIndex == 1){
        		Ext.getCmp('active_title').focus(true, 100);
        		Ext.getCmp('btnSecondStepEastBody').handler();
        	}else if(currentIndex == 2){
        		Ext.getCmp('threeStepEastBody').body.update(buildPreviewHead()+Ext.getCmp('secondStep_edit').getValue());
        	}
        },
        onStepChanging : function(event, currentIndex, newIndex){
        	if(currentIndex == 1 && newIndex == 2){
        		return fnValidSecondSteps();
        	}else{
        		return true;
        	}
        },
        onFinished: function(event, currentIndex, newIndex){
        	return operatePromotion();
        }
    });
});
</script>  	
</head>
<body>

<div id="divActive"></div>

 <div id="divActiveInsert"  style="display: none;padding-top: 5px;">
     <div id="wizard" style="width: 95%;margin-left: 2.5%">
            <span style="font-size: 25px;font-weight: bolder;color: red;'">选择活动模板</span>
            <div align="center">
					<div class="active_mould active_mould_default active_mould_click" onclick="selectPromotionModel(this, 4)">
	            		<img alt="" src="../../images/promotionTotalPointModel.png" width="230px" height="350px"><br><span id="span_firstModel"><input type="radio" name="rdo_activeMould" checked="checked" />模板一(累计积分)</span>
	            	</div>
	            	<div class="active_mould active_mould_default" onclick="selectPromotionModel(this, 3)">
	            		<img alt="" src="../../images/promotionOncePointModel.png" width="230px" height="350px"><br><span><input type="radio" name="rdo_activeMould" />模板二(单次积分)</span>
	            	</div>   
	            	<div class="active_mould active_mould_default" onclick="selectPromotionModel(this, 2)">
	            		<img alt="" src="../../images/promotionFreePointModel.png" width="230px" height="350px"><br><span ><input type="radio" name="rdo_activeMould" />模板三(免费领取)</span>
	            	</div>
	            	<div class="active_mould active_mould_default" onclick="selectPromotionModel(this, 1)">
	            		<img alt="" src="../../images/promotionDisplayModel.png" width="230px" height="350px"><br><span ><input type="radio" name="rdo_activeMould" />模板四(无优惠劵活动)</span>
	            	</div>
            </div>
				
			<span style="font-size: 25px;">填写活动信息</span>
			<div>
				<div id="active_secendStep" ></div>
				<div id="active_secendStep2" ></div>
				<div id="active_secendStep3" ></div>
			</div>
								
			<span style="font-size: 25px;">发布活动信息</span>
			<div>
				<div id="active_threeStep" ></div>
			</div>

    </div>
</div>	
</body>
</html>