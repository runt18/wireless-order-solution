<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1">
<title>促销信息</title>
<link rel="stylesheet" href="./css/base.css">
<link type="text/css" rel="stylesheet" href="./css/mbar.css">
<link type="text/css" rel="stylesheet" href="./css/general_foundicons.css">
<style type="text/css">
.box {
	margin-top : 5px;
	line-height : 15px;
	border:solid 5px #fff;
	height:115px;
	border:1px solid;
	border-radius:8px;	
	padding:2px;
	color:#666;
}
.box_in {
	float :left;
	background:#fff;
	border:solid 5px #fff;
	/* width:100%; */
	height:115px;
	border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
	padding:2px;
	color:#666;
}
.box .box_in {
	top:5px;
	left:5px;
	width:100px !important;
	height:100px;
	border-color:#593207;
	box-shadow:none;
}
.box span{
	margin-left: 5px;font-size: 15px;
	font-family:microsoft yahei, Arial, Helvetica, sans-serif;
	font-weight: bolder;
	line-height: 25px;
}

.box_in img{
	width : 100px;height : 100px;
}

.a_demo_two {
    background-color:#6fba26;
    padding:5px 30px 5px;
    position:relative;
    font-family: 'Open Sans', sans-serif;
    font-size:12px;
    text-decoration:none;
    color:#fff;
    background-image: linear-gradient(bottom, rgb(100,170,30) 0%, rgb(129,212,51) 100%);
    box-shadow: inset 0px 1px 0px #2ab7ec, 0px 3px 0px 0px #156785, 0px 4px 4px #999;
    border-radius: 5px;
}
 
.a_demo_two:active {
    top:4px;
    background-image: linear-gradient(bottom, rgb(100,170,30) 100%, rgb(129,212,51) 0%);
    box-shadow: inset 0px 1px 0px #2ab7ec, 0px 2px 0px 0px #156785, 0px 5px 3px #999;
    color: #156785;
    text-shadow: 0px 1px 1px rgba(255,255,255,0.3);
    background: rgb(44,160,202);
}
.a_demo_two:before {
    /* background-color:#072239 ; */
    content:"";
    display:block; 
    position:absolute;
    width:100%;
    height:100%;
    padding-left:2px;
    padding-right:2px;
    padding-bottom:4px;
    left:-2px;
     z-index:-1;
}

.hasCoupon{
	top : -100px;
	left : 200px;
	position:relative;
}
</style>
<script type="text/javascript" src="../../jquery/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="./js/Util.js"></script>
<script type="text/javascript">
function promotionRule(pType, point){
	var rule = '';
	if(pType == 3){
		rule = '单次消费积分满<font style="color: red">' + point + '</font>分即可领取优惠劵';
	}else if(pType == 4){
		rule = '累计消费积分满<font style="color: red">' + point + '</font>分即可领取优惠劵';
	}
	return '<div style="margin: 10px 10px 10px 10px; font-szie:14px;font-weight:bold;">'+ rule +'</div>';
}

function day_closeToPromotion(p_beginDate){
	var str = p_beginDate.replace(/-/g,"/");
	var beginDate = new Date(str);
	
	var newDate = new Date();
	
	var closeDay = Math.ceil((beginDate.getTime() - newDate.getTime()) / (1000* 3600 * 24));	
	
	if(closeDay > 0){
		return '<div style="margin: 10px 10px 10px 10px; font-size: 14px;font-weight: bold;text-align: right;">距离活动开始还有<font style="color: red">' + closeDay + '</font>天</div>'
	}else{
		return '';
	}
	
}

function customerPoint(pType, drawProgress, point){
	var rule = '';
	if(pType == 3){
		rule = '<span>您的单次消费最高积分为<font style="color: red">'+ drawProgress +'</font>分, 单次消费达<font style="color: blue">'+ point +'</font>分即可领取优惠券</span>';
	}else if(pType == 4){
		rule = '<span>您的累计积分为<font style="color: red">'+ drawProgress +'</font>分, 还差<font style="color: blue">'+ (point - drawProgress) +'</font>分即可领取优惠券</span>';
	}
	return rule;
}

function getCouponByPid(id){
	$.post('../../OperateCoupon.do', {couponId:id,fid : Util.mp.fid, dataSource:'draw'},function(result){
		if(result.success){
			$('#divHasCoupon').show();
			$('#div_getCouponBtn').hide();	
			$('#div_toMyCoupon').show();
			
		}else{
			Util.dialog.show({msg: result.msg});
		}
	});
}

var couponTemplet = '<div class="box">' +
					'<div class="box_in" ><img src="{couponImg}"><div id="divHasCoupon" style="display:none"><img src="../../images/hasCoupon.png" class="hasCoupon"></div></div>' + 
					'<br><span style="margin-top: 15px;">{name}</span><br><span >面额 : {cPrice} 元</span><br><span >到期 : {expiredTime}</span>' +
					'</div>';

$(function(){
	Util.lbar('', function(html){ $(document.body).append(html);  });
	var params ;
	if(Util.mp.extra){
		params = {
			dataSource : 'byId',
			fid : Util.mp.fid,
			couponId : Util.mp.extra
		}
	}else{
		params = {
			dataSource : 'byId',
			fid : Util.mp.fid,	
			couponId : 42
		}
	}
	
	$.ajax({
		url : '../../QueryCoupon.do',
		dataType : 'json',
		type : 'post',
		data : params,
		success : function(data, statuc, xhr){
			if(data.success && data.root.length > 0){
				
				var temp = data.root[0].promotion;
				Util.getDom('divInfoContent').innerHTML =  '<div style="margin: 10px 10px 10px 10px; text-align:center; font-size: 26px; font-weight: bold; word-wrap:break-word; color: #D2691E;">' + temp.title + '</div>'
					+ '<div style="margin: 10px 10px 10px 10px; color:#aaa; font-szie:12px;">活动日期 : ' + temp.promotionBeginDate + '&nbsp;至&nbsp;' + temp.promotionEndDate + '</div>'
					+ promotionRule(temp.pType, temp.point) 
					+ '<div style="margin: 10px 10px 10px 10px; word-wrap:break-word;">' + temp.body + '</div>'
					+ '<hr><div style="margin: 10px 10px 10px 10px; font-size: 14px;font-weight: bold;">'
					+ (data.root[0].drawProgress ? (data.root[0].drawProgress.point>=temp.point?'':customerPoint(temp.pType,data.root[0].drawProgress.point,temp.point)) : '' + '</div>')
					+ day_closeToPromotion(temp.promotionBeginDate)
					+ '<div style="margin: 10px 10px 10px 10px;">'
					+ (temp.pType != 1 ? couponTemplet.format({
						couponImg : data.root[0].couponType.image,
						name : data.root[0].couponType.name,
						cPrice : data.root[0].couponType.price,
						expiredTime : data.root[0].couponType.expiredFormat
					}) : '')
					+ '<div id="div_getCouponBtn" style="margin-top: 10px;text-align: center;display: none" ><a class="a_demo_two" style="font-size: 20px;font-weight: bold;" onclick="getCouponByPid('+data.root[0].couponId+')">领取优惠劵</a></div>'
					+ '<div id="div_toMyCoupon" style="text-align: right;font-size:15px;display: none;" ><br><a href="javascript:void(0)" onclick="Util.skip(\'member.html\', \'coupon\')" style="color:blue;text-decoration: underline;">→查看我的优惠劵</a></div>'
					+ '</div>';
					
				$('img').parent().css('width', '100%');	
				
				
				if(data.root[0].statusValue < 3){
					if(((data.root[0].drawProgress && data.root[0].drawProgress.point>=temp.point) && temp.pType > 1) && !day_closeToPromotion(temp.promotionBeginDate)){
						$('#div_getCouponBtn').show();
					}else{
						$('#div_getCouponBtn').hide();							
					}
					$('#divHasCoupon').hide();
					$('#div_toMyCoupon').hide();
				}else{
					$('#div_getCouponBtn').hide();		
					$('#div_toMyCoupon').show();
					$('#divHasCoupon').show();
								
				}
			}else{
				Util.getDom('divInfoContent').innerHTML = '暂无促销信息';
			}
		},
		error : function(xhr, errorType, error){
			alert('加载促销信息失败.');
		}
	});
	
});
</script>
</head>
<body>
<div id="divInfoContent"></div>

<div class="footer">&copy; 2014 技术支持：智易科技</div>
<div style="height: 45px;">&nbsp;</div>
</body>
</html>